<!DOCTYPE html>
<html lang="pt-BR"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--CSS-->
    <link rel="stylesheet" href="css/style.css">
    
    <title>üç¶ Chop Manager PRO - Sistema Completo TESTW</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    

</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üç¶</div>
                <div class="logo-text">
                    <h1>CHOP <span>MANAGER</span> PRO</h1>
                    <div style="font-size: 14px; opacity: 0.9;">Sistema Completo de Vendas</div>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="day-info">
                    <div id="currentDate" style="font-size: 16px; margin-bottom: 5px;">Carregando...</div>
                    <div id="currentTime" style="font-size: 24px; font-weight: 800; color: var(--accent);">00:00:00</div>
                </div>
                
                <button onclick="syncData()" id="syncButton" style="
                    background: linear-gradient(135deg, var(--secondary), #FF4081);
                    color: white; 
                    border: none; 
                    border-radius: 12px; 
                    padding: 10px 18px; 
                    cursor: pointer; 
                    font-size: 13px; 
                    font-weight: 700;
                    display: flex; 
                    align-items: center; 
                    gap: 8px;
                    transition: var(--transition);
                    box-shadow: 0 4px 12px rgba(255, 123, 172, 0.3);
                    white-space: nowrap;
                    height: fit-content;">
                    <i class="fas fa-sync-alt"></i> Sincronizar
                </button>
            </div>
        </header>
        
        <!-- NAVEGA√á√ÉO -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="nav-tab" data-page="vendas">
                <i class="fas fa-cash-register"></i> Vender
            </button>
            <button class="nav-tab" data-page="produtos">
                <i class="fas fa-ice-cream"></i> Produtos
            </button>
            <button class="nav-tab" data-page="fiados">
                <i class="fas fa-hand-holding-usd"></i> Fiados
            </button>
            <button class="nav-tab" data-page="relatorios">
                <i class="fas fa-chart-pie"></i> Relat√≥rios
            </button>
            <button class="nav-tab" data-page="config">
                <i class="fas fa-cog"></i> Configura√ß√µes
            </button>
        </nav>
        
        <!-- CONTE√öDO PRINCIPAL -->
        <main class="main-content">
            <!-- DASHBOARD -->
            <section id="dashboard" class="page active">
                <div class="page-title">
                    <i class="fas fa-tachometer-alt"></i>
                    <h2>Dashboard de Vendas</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px;">Faturamento Hoje</div>
                        <div style="font-size: 32px; font-weight: 900; color: var(--dark);" id="todayRevenue">R$ 0,00</div>
                        <div style="position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1;">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px;">Chops Vendidos</div>
                        <div style="font-size: 32px; font-weight: 900; color: var(--dark);" id="todayChops">0</div>
                        <div style="position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1;">
                            <i class="fas fa-ice-cream"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px;">M√©dia por Venda</div>
                        <div style="font-size: 32px; font-weight: 900; color: var(--dark);" id="avgSale">R$ 0,00</div>
                        <div style="position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1;">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px;">Estoque Baixo</div>
                        <div style="font-size: 32px; font-weight: 900; color: var(--dark);" id="lowStock">0</div>
                        <div style="position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
                
                <!-- GR√ÅFICOS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;">
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow);">
                        <h3 style="margin-bottom: 15px; color: var(--dark); font-size: 18px;">
                            <i class="fas fa-chart-pie"></i> Produtos Mais Vendidos
                        </h3>
                        <canvas id="flavorsChart" height="200"></canvas>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow);">
                        <h3 style="margin-bottom: 15px; color: var(--dark); font-size: 18px;">
                            <i class="fas fa-chart-line"></i> Evolu√ß√£o Semanal
                        </h3>
                        <canvas id="weeklyChart" height="200"></canvas>
                    </div>
                </div>
                
                <!-- DASHBOARD GRID -->
                <div class="dashboard-grid">
                    <!-- √öLTIMAS VENDAS -->
                    <div class="recent-sales-container">
                        <div class="sales-header">
                            <h3><i class="fas fa-history"></i> √öltimas Vendas</h3>
                            <button class="btn-primary" id="btnVerTodas" style="padding: 8px 15px; font-size: 12px;">
                                Ver Todas
                            </button>
                        </div>
                        <div id="recentSalesList" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando √∫ltimas vendas...</p>
                        </div>
                    </div>
                    
                    <!-- PRODUTOS MAIS VENDIDOS -->
                    <div class="top-products-container">
                        <div class="sales-header">
                            <h3><i class="fas fa-crown"></i> Top Produtos</h3>
                            <button class="btn-primary" id="btnVerTodosProdutos" style="padding: 8px 15px; font-size: 12px;">
                                Ver Todos
                            </button>
                        </div>
                        <div id="topProductsList" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando produtos...</p>
                        </div>
                    </div>
                </div>
                
                <!-- ESTOQUE BAIXO -->
                <div class="low-stock-container" id="lowStockContainer" style="display: none;">
                    <div class="sales-header">
                        <h3><i class="fas fa-exclamation-triangle"></i> Estoque Baixo</h3>
                        <button class="btn-primary" id="btnReporEstoque" style="padding: 8px 15px; font-size: 12px; background: var(--warning);">
                            Repor Estoque
                        </button>
                    </div>
                    <div id="lowStockList" class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Verificando estoque...</p>
                    </div>
                </div>
            </section>
            
            <!-- VENDAS -->
            <section id="vendas" class="page">
                <div class="page-title">
                    <i class="fas fa-cash-register"></i>
                    <h2>Vender Chop</h2>
                </div>
                
                <!-- PRODUTOS -->
                <div>
                    <h3 style="margin: 15px 0; color: var(--dark); font-size: 20px;">
                        <i class="fas fa-ice-cream"></i> Selecione os Produtos
                    </h3>
                    <div class="flavors-grid" id="productsGrid">
                        <div class="loading" style="grid-column: 1 / -1;">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando produtos...</p>
                        </div>
                    </div>
                </div>
                
                <!-- CARRINHO -->
                <div class="cart-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--dark); font-size: 22px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-shopping-cart"></i> Carrinho
                        </h3>
                        <button class="btn-primary" style="background: var(--danger); padding: 10px 20px; font-size: 14px;" id="clearCart">
                            <i class="fas fa-trash"></i> Limpar
                        </button>
                    </div>
                    
                    <div id="cartItems" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px;">
                        <div class="loading">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Selecione os produtos para come√ßar</p>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px;">
                            <span>Total de Itens:</span>
                            <span id="totalItems">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px;">
                            <span>Valor Total:</span>
                            <span id="totalValue">R$ 0,00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 24px; font-weight: 900; color: var(--dark); padding-top: 10px; border-top: 2px solid #dee2e6;">
                            <span>TOTAL:</span>
                            <span id="totalToPay">R$ 0,00</span>
                        </div>
                    </div>
                    
                    <!-- FORMAS DE PAGAMENTO -->
                    <div style="margin: 20px 0;">
                        <h4 style="margin-bottom: 15px; color: var(--dark); font-size: 18px;">
                            <i class="fas fa-credit-card"></i> Forma de Pagamento
                        </h4>
                        <div class="payment-options">
                            <label class="payment-option">
                                <input type="radio" name="payment" value="dinheiro" checked>
                                <div class="payment-card">
                                    <span class="payment-icon">üíµ</span>
                                    <div class="payment-name">Dinheiro</div>
                                </div>
                            </label>
                            
                            <label class="payment-option">
                                <input type="radio" name="payment" value="cartao">
                                <div class="payment-card">
                                    <span class="payment-icon">üí≥</span>
                                    <div class="payment-name">Cart√£o</div>
                                </div>
                            </label>
                            
                            <label class="payment-option">
                                <input type="radio" name="payment" value="pix">
                                <div class="payment-card">
                                    <span class="payment-icon">üì±</span>
                                    <div class="payment-name">PIX</div>
                                </div>
                            </label>
                            
                            <label class="payment-option">
                                <input type="radio" name="payment" value="fiado">
                                <div class="payment-card">
                                    <span class="payment-icon">üìù</span>
                                    <div class="payment-name">Fiado</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn-primary" id="finalizeSale" disabled style="width: 100%;">
                        <i class="fas fa-check-circle"></i>
                        FINALIZAR VENDA
                    </button>
                </div>
            </section>
            
            <!-- PRODUTOS -->
            <section id="produtos" class="page">
                <div class="page-title">
                    <i class="fas fa-ice-cream"></i>
                    <h2>Gest√£o de Produtos</h2>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <p style="color: var(--gray); font-size: 16px;">
                        Cadastre e gerencie seus produtos
                    </p>
                    <button class="btn-primary" id="addProduct" style="padding: 12px 25px; font-size: 16px;">
                        <i class="fas fa-plus"></i>
                        Novo Produto
                    </button>
                </div>
                
                <!-- FILTROS DE PRODUTOS -->
                <div style="background: white; padding: 15px; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 700; color: var(--dark); font-size: 14px;">Filtrar por:</label>
                            <select id="productFilter" style="padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 14px; min-width: 150px;">
                                <option value="todos">Todos os Produtos</option>
                                <option value="estoque-baixo">Estoque Baixo</option>
                                <option value="mais-vendidos">Mais Vendidos</option>
                                <option value="ativos">Ativos</option>
                                <option value="inativos">Inativos</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="productSearch" placeholder="Buscar produto..." style="width: 100%; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 14px;">
                        </div>
                    </div>
                </div>
                
                <div class="flavors-grid" id="productsList">
                    <div class="loading" style="grid-column: 1 / -1;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando produtos...</p>
                    </div>
                </div>
            </section>
            
            <!-- FIADOS -->
            <section id="fiados" class="page">
                <div class="page-title">
                    <i class="fas fa-hand-holding-usd"></i>
                    <h2>Controle de Fiados</h2>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <p style="color: var(--gray); font-size: 16px;">
                        Gerencie vendas fiadas e recebimentos
                    </p>
                    <button class="btn-primary" id="novoFiado" style="padding: 12px 25px; font-size: 16px;">
                        <i class="fas fa-plus"></i>
                        Novo Fiado
                    </button>
                </div>
                
                <!-- RESUMO DE FIADOS -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px;">Total a Receber</div>
                        <div style="font-size: 32px; font-weight: 900; color: var(--dark);" id="totalReceber">R$ 0,00</div>
                        <div style="position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1;">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px;">Recebido M√™s</div>
                        <div style="font-size: 32px; font-weight: 900; color: var(--success);" id="recebidoMes">R$ 0,00</div>
                        <div style="position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1;">
                            <i class="fas fa-cash-register"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px;">Clientes em Atraso</div>
                        <div style="font-size: 32px; font-weight: 900; color: var(--danger);" id="clientesAtraso">0</div>
                        <div style="position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="font-size: 14px; color: var(--gray); margin-bottom: 10px;">Fiados Ativos</div>
                        <div style="font-size: 32px; font-weight: 900; color: var(--warning);" id="fiadosAtivos">0</div>
                        <div style="position: absolute; right: 20px; top: 20px; font-size: 30px; opacity: 0.1;">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
                
                <!-- FILTROS -->
                <div style="background: white; padding: 15px; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 700; color: var(--dark); font-size: 14px;">Status:</label>
                            <select id="filterStatus" style="padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 14px; min-width: 150px;">
                                <option value="todos">Todos</option>
                                <option value="pendente">Pendentes</option>
                                <option value="atrasado">Em Atraso</option>
                                <option value="pago">Pagos</option>
                                <option value="parcial">Parcialmente Pagos</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="searchCliente" placeholder="Buscar cliente..." style="width: 100%; padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 14px;">
                        </div>
                        
                        <button class="btn-primary" id="btnExportFiados" style="padding: 10px 20px; font-size: 14px;">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                    </div>
                </div>
                
                <!-- LISTA DE FIADOS -->
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow);">
                    <div id="fiadosList" class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando fiados...</p>
                    </div>
                </div>
            </section>
            
            <!-- RELAT√ìRIOS -->
            <section id="relatorios" class="page">
                <div class="page-title">
                    <i class="fas fa-chart-pie"></i>
                    <h2>Relat√≥rios e Exporta√ß√£o</h2>
                </div>
                
                <!-- FILTROS -->
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 700; color: var(--dark); font-size: 14px;">Per√≠odo:</label>
                            <select id="reportPeriod" style="padding: 10px 15px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 14px; min-width: 150px;">
                                <option value="hoje">Hoje</option>
                                <option value="ontem">Ontem</option>
                                <option value="semana">Esta Semana</option>
                                <option value="mes" selected>Este M√™s</option>
                                <option value="ano">Este Ano</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                        
                        <div id="customDateRange" style="display: none; flex: 1;">
                            <div style="display: flex; gap: 10px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 700; color: var(--dark); font-size: 14px;">De:</label>
                                    <input type="date" id="startDate" style="padding: 10px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 14px; width: 100%;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 700; color: var(--dark); font-size: 14px;">At√©:</label>
                                    <input type="date" id="endDate" style="padding: 10px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 14px; width: 100%;">
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-left: auto;">
                            <button class="btn-primary" id="generateReportBtn" style="font-size: 14px; padding: 10px 20px;">
                                <i class="fas fa-sync-alt"></i>
                                Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                    
                    <!-- BOT√ïES DE EXPORTA√á√ÉO -->
                    <div class="export-buttons">
                        <button class="export-btn print" id="printReport">
                            <i class="fas fa-print"></i>
                            Imprimir Relat√≥rio
                        </button>
                    </div>
                </div>
                
                <!-- CONTE√öDO DO RELAT√ìRIO -->
                <div id="reportContent" style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow);">
                    <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
                        <i class="fas fa-chart-pie" style="font-size: 60px; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p style="font-size: 16px;">Selecione um per√≠odo e clique em "Gerar Relat√≥rio"</p>
                    </div>
                </div>
            </section>
            
            <!-- CONFIGURA√á√ïES -->
            <section id="config" class="page">
                <div class="page-title">
                    <i class="fas fa-cog"></i>
                    <h2>Configura√ß√µes do Sistema</h2>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- BACKUP -->
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow);">
                        <h3 style="margin-bottom: 15px; color: var(--dark); font-size: 18px;">
                            <i class="fas fa-database"></i> Backup de Dados
                        </h3>
                        <p style="color: var(--gray); margin-bottom: 20px; font-size: 14px;">
                            Fa√ßa backup de todos os dados do sistema.
                        </p>
                        <button class="btn-primary" id="backupBtn" style="width: 100%; padding: 12px;">
                            <i class="fas fa-save"></i>
                            Fazer Backup
                        </button>
                    </div>
                    
                    <!-- INFORMA√á√ïES -->
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: var(--shadow);">
                        <h3 style="margin-bottom: 15px; color: var(--dark); font-size: 18px;">
                            <i class="fas fa-info-circle"></i> Informa√ß√µes do Sistema
                        </h3>
                        <div style="color: var(--gray); font-size: 14px;">
                            <p><strong>Vers√£o:</strong> Chop Manager PRO 2.1</p>
                            <p><strong>Produtos:</strong> <span id="totalProducts">0</span></p>
                            <p><strong>Vendas:</strong> <span id="totalSales">0</span></p>
                            <p><strong>Faturamento Total:</strong> <span id="totalRevenue">R$ 0,00</span></p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- FOOTER -->
        <footer class="footer">
            <p>üç¶ Sistema Chop Manager PRO - Vers√£o 2.1</p>
            <p style="margin-top: 8px; font-size: 12px; opacity: 0.8;">
                Sistema completo para gest√£o de vendas de sorvete
            </p>
        </footer>
    </div>
    
    <!-- MODAL DE PRODUTO -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div style="padding: 20px; background: linear-gradient(135deg, var(--primary), #2A9D8F); color: white; border-radius: 15px 15px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-ice-cream"></i>
                        <span id="modalTitle">Novo Produto</span>
                    </div>
                    <button id="closeModal" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        &times;
                    </button>
                </div>
            </div>
            
            <div style="padding: 20px;">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <!-- FOTO DO PRODUTO -->
                    <div class="form-group">
                        <label class="form-label">Foto do Produto (opcional)</label>
                        <div class="photo-upload-container" id="photoUploadContainer">
                            <div class="upload-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <p style="color: var(--gray); margin-bottom: 8px; font-size: 14px;">Clique para adicionar uma foto</p>
                            <p style="font-size: 12px; color: var(--gray);">Formatos: JPG, PNG (max. 2MB)</p>
                            <img id="photoPreview" class="photo-preview" alt="Preview da foto">
                        </div>
                        <input type="file" id="productPhoto" accept="image/*" style="display: none;">
                        <input type="hidden" id="productPhotoData">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nome do Produto *</label>
                        <input type="text" id="productName" class="form-input" placeholder="Ex: Casquinha de Chocolate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Descri√ß√£o</label>
                        <textarea id="productDescription" class="form-input" rows="2" placeholder="Descreva o produto..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Pre√ßo (R$) *</label>
                        <input type="number" id="productPrice" class="form-input" step="0.01" min="0" placeholder="5.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Estoque Inicial *</label>
                        <input type="number" id="productStock" class="form-input" min="0" placeholder="100" required>
                    </div>
                    
                    <!-- PERSONALIZA√á√ÉO DE EMOJI -->
                    <div class="form-group">
                        <label class="form-label">Emoji do Produto</label>
                        <div class="emoji-selected" id="emojiSelector">
                            <span id="selectedEmoji">üç¶</span>
                            <span style="color: var(--gray); font-size: 14px;">Clique para escolher um emoji</span>
                        </div>
                        <div class="emoji-picker" id="emojiPicker">
                            <!-- Emojis ser√£o inseridos por JavaScript -->
                        </div>
                        <input type="hidden" id="productEmoji" value="üç¶">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cor de Identifica√ß√£o</label>
                        <input type="color" id="productColor" value="#36B5B0" style="width: 100%; height: 40px; border-radius: 10px; border: 2px solid #dee2e6; cursor: pointer;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="productActive" checked style="width: 20px; height: 20px;">
                            <span>Produto Ativo</span>
                        </label>
                    </div>
                </form>
            </div>
            
            <div style="padding: 15px 20px; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-primary" id="cancelModal" style="background: var(--gray); padding: 10px 20px;">
                    Cancelar
                </button>
                <button class="btn-primary" id="saveProduct" style="padding: 10px 20px;">
                    Salvar Produto
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL FIADO -->
    <div class="modal-overlay" id="fiadoModal">
        <div class="modal" style="max-width: 600px;">
            <div style="padding: 20px; background: linear-gradient(135deg, #FF7BAC, #FF4081); color: white; border-radius: 15px 15px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-hand-holding-usd"></i>
                        <span id="modalFiadoTitle">Novo Fiado</span>
                    </div>
                    <button id="closeFiadoModal" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        &times;
                    </button>
                </div>
            </div>
            
            <div style="padding: 20px;">
                <form id="fiadoForm">
                    <input type="hidden" id="fiadoIndex">
                    
                    <div class="form-group">
                        <label class="form-label">Nome do Cliente *</label>
                        <input type="text" id="nomeCliente" class="form-input" placeholder="Nome completo" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="text" id="telefoneCliente" class="form-input" placeholder="(11) 99999-9999">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Produtos *</label>
                        <div id="produtosFiadoContainer">
                            <!-- Produtos ser√£o adicionados dinamicamente -->
                        </div>
                        <button type="button" class="btn-primary" id="addProdutoFiado" style="margin-top: 10px; padding: 8px 15px; font-size: 14px;">
                            <i class="fas fa-plus"></i> Adicionar Produto
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Prazo de Pagamento *</label>
                        <input type="date" id="prazoPagamento" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data de Retirada</label>
                        <input type="date" id="dataRetirada" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Valor Pago Inicial (se houver)</label>
                        <input type="number" id="valorPago" class="form-input" step="0.01" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea id="observacoes" class="form-input" rows="3" placeholder="Observa√ß√µes importantes..."></textarea>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 700;">
                            <span>Total:</span>
                            <span id="fiadoTotal">R$ 0,00</span>
                        </div>
                    </div>
                </form>
            </div>
            
            <div style="padding: 15px 20px; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-primary" id="cancelFiadoModal" style="background: var(--gray); padding: 10px 20px;">
                    Cancelar
                </button>
                <button class="btn-primary" id="saveFiado" style="padding: 10px 20px;">
                    Salvar Fiado
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PAGAMENTO FIADO -->
    <div class="modal-overlay" id="pagamentoModal">
        <div class="modal" style="max-width: 500px;">
            <div style="padding: 20px; background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border-radius: 15px 15px 0 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Registrar Pagamento</span>
                    </div>
                    <button onclick="fecharPagamentoModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        &times;
                    </button>
                </div>
            </div>
            
            <div style="padding: 20px;">
                <div id="pagamentoInfo" style="margin-bottom: 20px;"></div>
                
                <div class="form-group">
                    <label class="form-label">Valor do Pagamento *</label>
                    <input type="number" id="valorPagamento" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Data do Pagamento</label>
                    <input type="date" id="dataPagamento" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Forma de Pagamento</label>
                    <select id="formaPagamento" class="form-input">
                        <option value="dinheiro">Dinheiro</option>
                        <option value="pix">PIX</option>
                        <option value="cartao">Cart√£o</option>
                        <option value="transferencia">Transfer√™ncia</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea id="obsPagamento" class="form-input" rows="2" placeholder="Observa√ß√µes sobre o pagamento..."></textarea>
                </div>
            </div>
            
            <div style="padding: 15px 20px; border-top: 2px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-primary" onclick="fecharPagamentoModal()" style="background: var(--gray); padding: 10px 20px;">
                    Cancelar
                </button>
                <button class="btn-primary" onclick="confirmarPagamento()" style="padding: 10px 20px;">
                    Registrar Pagamento
                </button>
            </div>
        </div>
    </div>
    
    <!-- NOTIFICA√á√ïES -->
    <div class="notification" id="notification"></div>
<script>
// ===== CONFIGURA√á√ÉO NEON =====
const API_URL = 'https://helbertbarbosa07-vendaschopp.vercel.app/api/neon';

let produtos = [];
let vendas = [];
let fiados = [];
let carrinho = [];
let charts = {};
let isLoading = false;
let currentFiadoEditing = null;

// ===== TESTE DE CONEX√ÉO =====
async function testConnection() {
    try {
        console.log('üîå Testando conex√£o com API...');
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'test' })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('‚úÖ API conectada:', data);
            return true;
        } else {
            console.error('‚ùå API n√£o respondeu corretamente');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Falha na conex√£o:', error);
        return false;
    }
}

// ===== FUN√á√ÉO PRINCIPAL NEON =====
async function neonAPI(action, data = null) {
    if (isLoading && action !== 'create_venda') {
        console.log(`‚è≥ ${action} em espera (j√° carregando)`);
        return;
    }
    
    try {
        isLoading = true;
        console.log(`üîÑ Executando: ${action}`, data);
        
        // Mapear a√ß√µes para a API correta
        let apiAction = action;
        const actionMap = {
            'create_fiado': 'create_credito',
            'get_fiados': 'get_creditos',
            'update_fiado': 'update_credito',
            'delete_fiado': 'delete_credito'
        };
        
        if (actionMap[action]) {
            apiAction = actionMap[action];
        }
        
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: apiAction, 
                data: data 
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Erro na API');
        }
        
        console.log(`‚úÖ ${action} executado com sucesso`);
        return result.data;
        
    } catch (error) {
        console.error(`‚ùå Erro em ${action}:`, error);
        showNotification(`Erro: ${error.message}`, 'error');
        throw error;
    } finally {
        isLoading = false;
    }
}

// ===== FUN√á√ïES AUXILIARES =====
function formatPrice(value) {
    if (value === undefined || value === null || value === '') return '0,00';
    const num = Number(value);
    return isNaN(num) ? '0,00' : num.toLocaleString('pt-BR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

function formatarData(dataString) {
    try {
        const data = new Date(dataString);
        if (isNaN(data.getTime())) return 'Data inv√°lida';
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
    } catch (e) {
        return 'Data inv√°lida';
    }
}

function updateDateTime() {
    const now = new Date();
    const optionsDate = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    
    const dateElement = document.getElementById('currentDate');
    const timeElement = document.getElementById('currentTime');
    
    if (dateElement) {
        dateElement.textContent = now.toLocaleDateString('pt-BR', optionsDate);
    }
    
    if (timeElement) {
        timeElement.textContent = now.toLocaleTimeString('pt-BR');
    }
}

function showNotification(mensagem, tipo = 'info') {
    const notification = document.getElementById('notification');
    if (!notification) {
        console.log(`[${tipo.toUpperCase()}] ${mensagem}`);
        return;
    }
    
    notification.textContent = mensagem;
    notification.className = `notification ${tipo} show`;
    
    // Remover notifica√ß√£o ap√≥s 3 segundos
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// ===== DASHBOARD COMPLETO =====
async function loadDashboard() {
    try {
        showNotification('üîÑ Carregando dashboard...', 'info');
        
        // 1. Carregar estat√≠sticas do dashboard
        const stats = await neonAPI('get_dashboard_stats');
        
        // Atualizar estat√≠sticas b√°sicas
        document.getElementById('todayRevenue').textContent = 
            `R$ ${formatPrice(stats.faturamentoHoje || 0)}`;
        
        document.getElementById('todayChops').textContent = 
            stats.totalItens || 0;
        
        document.getElementById('avgSale').textContent = 
            stats.totalVendas > 0 
                ? `R$ ${formatPrice((stats.faturamentoHoje || 0) / stats.totalVendas)}` 
                : 'R$ 0,00';
        
        document.getElementById('lowStock').textContent = 
            stats.estoqueBaixo || 0;
        
        // 2. Carregar √∫ltimas vendas
        await loadUltimasVendas();
        
        // 3. Carregar produtos mais vendidos
        await loadProdutosMaisVendidos();
        
        // 4. Carregar estoque baixo
        await loadEstoqueBaixo();
        
        // 5. Carregar gr√°ficos
        await loadGraficos();
        
        showNotification('‚úÖ Dashboard carregado com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        showNotification('‚ùå Erro ao carregar dashboard', 'error');
        
        // Mostrar dados em branco em caso de erro
        document.getElementById('recentSalesList').innerHTML = `
            <div class="empty-sales">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erro ao carregar vendas</p>
            </div>
        `;
        
        document.getElementById('topProductsList').innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Erro ao carregar produtos</p>
            </div>
        `;
    }
}

async function loadUltimasVendas() {
    try {
        const recentSales = await neonAPI('get_vendas_recentes');
        const lista = document.getElementById('recentSalesList');
        
        if (!Array.isArray(recentSales) || recentSales.length === 0) {
            lista.innerHTML = `
                <div class="empty-sales">
                    <i class="fas fa-shopping-cart"></i>
                    <p>Nenhuma venda recente</p>
                </div>
            `;
            return;
        }
        
        let html = `
            <div style="overflow-x: auto;">
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Produtos</th>
                            <th>Valor</th>
                            <th>Pagamento</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Pegar apenas as √∫ltimas 5 vendas
        recentSales.slice(0, 5).forEach(venda => {
            const hora = venda.hora || '--:--';
            const total = venda.total || 0;
            const pagamento = venda.pagamento || 'dinheiro';
            const produtosCount = venda.total_itens || 1;
            
            const pagamentoClass = {
                'dinheiro': 'payment-dinheiro',
                'cartao': 'payment-cartao',
                'pix': 'payment-pix',
                'fiado': 'payment-fiado'
            }[pagamento] || 'payment-dinheiro';
            
            const pagamentoText = {
                'dinheiro': 'Dinheiro',
                'cartao': 'Cart√£o',
                'pix': 'PIX',
                'fiado': 'Fiado'
            }[pagamento] || pagamento;
            
            html += `
                <tr>
                    <td>${hora}</td>
                    <td>${produtosCount} itens</td>
                    <td><strong>R$ ${formatPrice(total)}</strong></td>
                    <td>
                        <span class="payment-badge ${pagamentoClass}">
                            ${pagamentoText}
                        </span>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        lista.innerHTML = html;
        
    } catch (error) {
        console.error('Erro ao carregar √∫ltimas vendas:', error);
        throw error;
    }
}

async function loadProdutosMaisVendidos() {
    try {
        const produtosAPI = await neonAPI('get_produtos');
        const lista = document.getElementById('topProductsList');
        
        if (!Array.isArray(produtosAPI) || produtosAPI.length === 0) {
            lista.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--gray);">
                    <i class="fas fa-ice-cream" style="font-size: 30px;"></i>
                    <p>Nenhum produto encontrado</p>
                </div>
            `;
            return;
        }
        
        // Filtrar produtos ativos
        const produtosAtivos = produtosAPI.filter(p => p.ativo);
        
        if (produtosAtivos.length === 0) {
            lista.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--gray);">
                    <i class="fas fa-ban" style="font-size: 30px;"></i>
                    <p>Nenhum produto ativo</p>
                </div>
            `;
            return;
        }
        
        // Ordenar por vendas (simula√ß√£o - usar campo dispon√≠vel)
        const produtosOrdenados = produtosAtivos
            .sort((a, b) => {
                const vendasA = a.total_vendido || a.vendas_semanais || a.vendas_mes || 0;
                const vendasB = b.total_vendido || b.vendas_semanais || b.vendas_mes || 0;
                return vendasB - vendasA;
            })
            .slice(0, 5); // Top 5
        
        let html = '<div class="top-products-list">';
        
        produtosOrdenados.forEach((produto, index) => {
            const vendasCount = produto.total_vendido || produto.vendas_semanais || produto.vendas_mes || 0;
            const estoque = produto.estoque || 0;
            const emoji = produto.emoji || 'üç¶';
            
            html += `
                <div class="top-product-item">
                    <div class="top-product-emoji">${emoji}</div>
                    <div class="top-product-info">
                        <div class="top-product-name">${produto.nome}</div>
                        <div class="top-product-stats">
                            <span>${vendasCount} vendas</span>
                            <span>${estoque} em estoque</span>
                        </div>
                    </div>
                    <div class="top-product-rank">${index + 1}</div>
                </div>
            `;
        });
        
        html += '</div>';
        lista.innerHTML = html;
        
    } catch (error) {
        console.error('Erro ao carregar produtos mais vendidos:', error);
        throw error;
    }
}

async function loadEstoqueBaixo() {
    try {
        const produtosAPI = await neonAPI('get_produtos');
        const container = document.getElementById('lowStockContainer');
        const lista = document.getElementById('lowStockList');
        
        if (!Array.isArray(produtosAPI)) {
            container.style.display = 'none';
            return;
        }
        
        // Filtrar produtos ativos com estoque baixo (‚â§ 10 unidades)
        const estoqueBaixo = produtosAPI.filter(p => 
            p.ativo && p.estoque > 0 && p.estoque <= 10
        );
        
        if (estoqueBaixo.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        // Mostrar container
        container.style.display = 'block';
        
        let html = '<div class="low-stock-list">';
        
        estoqueBaixo.slice(0, 6).forEach(produto => {
            const emoji = produto.emoji || '‚ö†Ô∏è';
            const estoque = produto.estoque;
            const nivel = estoque <= 3 ? 'CR√çTICO' : 'BAIXO';
            const cor = estoque <= 3 ? '#dc3545' : '#ff9800';
            
            html += `
                <div class="low-stock-item">
                    <div class="low-stock-emoji">${emoji}</div>
                    <div class="low-stock-info">
                        <div class="low-stock-name">${produto.nome}</div>
                        <div class="low-stock-quantity">
                            <span style="color: ${cor}; font-weight: 700;">
                                ${estoque} unidades
                            </span>
                            <span style="font-size: 10px; margin-left: 5px;">
                                (${nivel})
                            </span>
                        </div>
                    </div>
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        lista.innerHTML = html;
        
    } catch (error) {
        console.error('Erro ao carregar estoque baixo:', error);
        document.getElementById('lowStockContainer').style.display = 'none';
    }
}

async function loadGraficos() {
    try {
        // Destruir gr√°ficos existentes
        if (charts.flavorsChart) {
            charts.flavorsChart.destroy();
        }
        if (charts.weeklyChart) {
            charts.weeklyChart.destroy();
        }
        
        // 1. Gr√°fico de produtos mais vendidos
        const produtosAPI = await neonAPI('get_produtos');
        const produtosAtivos = produtosAPI.filter(p => p.ativo);
        
        const topProdutos = produtosAtivos
            .sort((a, b) => {
                const vendasA = a.total_vendido || a.vendas_semanais || a.vendas_mes || 0;
                const vendasB = b.total_vendido || b.vendas_semanais || b.vendas_mes || 0;
                return vendasB - vendasA;
            })
            .slice(0, 5);
        
        const ctx1 = document.getElementById('flavorsChart')?.getContext('2d');
        if (ctx1 && topProdutos.length > 0) {
            const vendasData = topProdutos.map(p => 
                p.total_vendido || p.vendas_semanais || p.vendas_mes || 1
            );
            const nomes = topProdutos.map(p => 
                p.nome.length > 15 ? p.nome.substring(0, 15) + '...' : p.nome
            );
            
            charts.flavorsChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: nomes,
                    datasets: [{
                        data: vendasData,
                        backgroundColor: [
                            '#36B5B0', // primary
                            '#FF7BAC', // secondary
                            '#FFD166', // accent
                            '#4CAF50', // success
                            '#9C27B0'  // purple
                        ],
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                },
                                color: '#333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw} vendas`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 2. Gr√°fico de evolu√ß√£o semanal (dados simulados)
        const ctx2 = document.getElementById('weeklyChart')?.getContext('2d');
        if (ctx2) {
            const dias = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
            const valores = dias.map(() => Math.floor(Math.random() * 500) + 100);
            
            charts.weeklyChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: dias,
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: valores,
                        borderColor: '#36B5B0',
                        backgroundColor: 'rgba(54, 181, 176, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#36B5B0',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#333',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value;
                                },
                                color: '#666'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                color: '#666'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
    } catch (error) {
        console.error('Erro ao carregar gr√°ficos:', error);
        // N√£o mostrar erro para o usu√°rio, apenas no console
    }
}

// ===== SISTEMA DE VENDAS =====
async function finalizeSale() {
    try {
        if (carrinho.length === 0) {
            showNotification('‚ùå Carrinho vazio! Adicione produtos antes de finalizar.', 'error');
            return;
        }
        
        const formaPagamento = document.querySelector('input[name="payment"]:checked')?.value || 'dinheiro';
        const total = carrinho.reduce((sum, item) => sum + (item.total || 0), 0);
        const totalItens = carrinho.reduce((sum, item) => sum + (item.quantidade || 0), 0);
        
        // Verificar se todos os produtos t√™m estoque suficiente
        for (const item of carrinho) {
            const produto = produtos.find(p => p.id === item.produtoId);
            if (!produto) {
                showNotification(`‚ùå Produto "${item.nome}" n√£o encontrado!`, 'error');
                return;
            }
            if (produto.estoque < item.quantidade) {
                showNotification(`‚ùå Estoque insuficiente para "${item.nome}"! Dispon√≠vel: ${produto.estoque}`, 'error');
                return;
            }
        }
        
        // Se for fiado, redirecionar para aba de fiados
        if (formaPagamento === 'fiado') {
            showNotification('‚ö†Ô∏è Para vendas fiadas, use a aba "Fiados"', 'warning');
            navigateTo('fiados');
            return;
        }
        
        // Criar objeto da venda
        const vendaData = {
            data: new Date().toISOString().split('T')[0],
            hora: new Date().toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }),
            total: total,
            total_itens: totalItens,
            pagamento: formaPagamento,
            status: 'concluida',
            itens: carrinho.map(item => ({
                produto_id: item.produtoId,
                quantidade: item.quantidade,
                preco: item.preco,
                total: item.total
            }))
        };
        
        console.log('üì¶ Enviando venda para API:', vendaData);
        
        // Salvar venda na API
        await neonAPI('create_venda', vendaData);
        
        // Atualizar estoque dos produtos
        for (const item of carrinho) {
            const produtoIndex = produtos.findIndex(p => p.id === item.produtoId);
            if (produtoIndex !== -1) {
                produtos[produtoIndex].estoque -= item.quantidade;
                
                // Atualizar no banco de dados (opcional)
                try {
                    await neonAPI('update_produto', {
                        id: item.produtoId,
                        estoque: produtos[produtoIndex].estoque
                    });
                } catch (error) {
                    console.error(`Erro ao atualizar estoque do produto ${item.produtoId}:`, error);
                }
            }
        }
        
        // Limpar carrinho
        carrinho = [];
        updateCart();
        
        // Atualizar dashboard
        await loadDashboard();
        await loadProductsForSale();
        
        // Mostrar mensagem de sucesso
        const metodoPagamento = {
            'dinheiro': 'üíµ Dinheiro',
            'cartao': 'üí≥ Cart√£o',
            'pix': 'üì± PIX'
        }[formaPagamento] || formaPagamento;
        
        showNotification(`‚úÖ Venda finalizada! R$ ${formatPrice(total)} via ${metodoPagamento}`, 'success');
        
        // Voltar para dashboard ap√≥s 2 segundos
        setTimeout(() => {
            navigateTo('dashboard');
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå Erro ao finalizar venda:', error);
        showNotification(`‚ùå Erro ao finalizar venda: ${error.message}`, 'error');
    }
}

// ===== SISTEMA DE CARRINHO =====
window.addToCart = function(produtoId) {
    const produto = produtos.find(p => p.id === produtoId);
    if (!produto) {
        showNotification('‚ùå Produto n√£o encontrado!', 'error');
        return;
    }
    
    if (!produto.ativo) {
        showNotification('‚ùå Produto n√£o est√° ativo!', 'error');
        return;
    }
    
    if (produto.estoque <= 0) {
        showNotification('‚ùå Produto sem estoque dispon√≠vel!', 'error');
        return;
    }
    
    const existingItem = carrinho.find(item => item.produtoId === produtoId);
    
    if (existingItem) {
        if (existingItem.quantidade >= produto.estoque) {
            showNotification(`‚ùå Estoque insuficiente! Dispon√≠vel: ${produto.estoque}`, 'warning');
            return;
        }
        existingItem.quantidade++;
        existingItem.total = existingItem.quantidade * existingItem.preco;
    } else {
        carrinho.push({
            produtoId: produto.id,
            nome: produto.nome,
            emoji: produto.emoji || 'üç¶',
            preco: produto.preco,
            quantidade: 1,
            total: produto.preco
        });
    }
    
    updateCart();
    showNotification(`‚úÖ ${produto.emoji || 'üç¶'} ${produto.nome} adicionado ao carrinho!`, 'success');
};

function updateCart() {
    const cartItems = document.getElementById('cartItems');
    const totalItems = carrinho.reduce((sum, item) => sum + (item.quantidade || 0), 0);
    const totalValue = carrinho.reduce((sum, item) => sum + (item.total || 0), 0);
    
    // Atualizar totais
    if (document.getElementById('totalItems')) {
        document.getElementById('totalItems').textContent = totalItems;
    }
    if (document.getElementById('totalValue')) {
        document.getElementById('totalValue').textContent = `R$ ${formatPrice(totalValue)}`;
    }
    if (document.getElementById('totalToPay')) {
        document.getElementById('totalToPay').textContent = `R$ ${formatPrice(totalValue)}`;
    }
    
    // Atualizar bot√£o de finalizar
    const finalizeBtn = document.getElementById('finalizeSale');
    if (finalizeBtn) {
        finalizeBtn.disabled = carrinho.length === 0;
        if (carrinho.length === 0) {
            finalizeBtn.style.opacity = '0.6';
            finalizeBtn.style.cursor = 'not-allowed';
        } else {
            finalizeBtn.style.opacity = '1';
            finalizeBtn.style.cursor = 'pointer';
        }
    }
    
    // Atualizar lista de itens
    if (!cartItems) return;
    
    if (carrinho.length === 0) {
        cartItems.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--gray);">
                <i class="fas fa-shopping-cart" style="font-size: 50px; opacity: 0.3;"></i>
                <p style="margin-top: 15px; font-size: 16px;">Selecione os produtos para come√ßar</p>
                <p style="font-size: 14px; opacity: 0.7;">Clique nos produtos acima para adicionar</p>
            </div>
        `;
        return;
    }
    
    let html = `<div style="max-height: 250px; overflow-y: auto; padding-right: 5px;">`;
    
    carrinho.forEach((item, index) => {
        const produto = produtos.find(p => p.id === item.produtoId);
        const estoqueDisponivel = produto ? produto.estoque : 0;
        
        html += `
            <div style="
                display: flex; 
                align-items: center; 
                padding: 15px; 
                background: white;
                border-radius: 10px;
                margin-bottom: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                transition: all 0.3s ease;
            ">
                <span style="font-size: 24px; margin-right: 15px;">${item.emoji}</span>
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--dark); margin-bottom: 5px;">
                        ${item.nome}
                    </div>
                    <div style="font-size: 12px; color: var(--gray);">
                        R$ ${formatPrice(item.preco)} un. ‚Ä¢ 
                        <span style="color: ${estoqueDisponivel < 10 ? 'var(--warning)' : 'var(--success)'};">
                            Estoque: ${estoqueDisponivel}
                        </span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="
                        display: flex; 
                        align-items: center; 
                        background: #f8f9fa; 
                        border-radius: 8px;
                        padding: 5px;
                    ">
                        <button onclick="updateCartItem(${index}, -1)" 
                                style="
                                    width: 30px; 
                                    height: 30px; 
                                    border: none; 
                                    background: #e9ecef; 
                                    border-radius: 6px; 
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 14px;
                                    color: var(--dark);
                                ">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span style="
                            width: 40px; 
                            text-align: center; 
                            font-weight: 700;
                            font-size: 16px;
                        ">${item.quantidade}</span>
                        <button onclick="updateCartItem(${index}, 1)" 
                                style="
                                    width: 30px; 
                                    height: 30px; 
                                    border: none; 
                                    background: #e9ecef; 
                                    border-radius: 6px; 
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 14px;
                                    color: var(--dark);
                                ">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div style="width: 90px; text-align: right; font-weight: 700; font-size: 16px;">
                        R$ ${formatPrice(item.total)}
                    </div>
                    <button onclick="removeCartItem(${index})" 
                            style="
                                background: var(--danger); 
                                color: white; 
                                border: none; 
                                width: 30px; 
                                height: 30px; 
                                border-radius: 6px; 
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 12px;
                                transition: all 0.3s ease;
                            ">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    html += `</div>`;
    cartItems.innerHTML = html;
}

window.updateCartItem = function(index, change) {
    if (index < 0 || index >= carrinho.length) return;
    
    const item = carrinho[index];
    const produto = produtos.find(p => p.id === item.produtoId);
    
    if (!produto) return;
    
    const newQuantity = item.quantidade + change;
    
    // Verificar se pode remover
    if (newQuantity < 1) {
        removeCartItem(index);
        return;
    }
    
    // Verificar se tem estoque suficiente
    if (newQuantity > produto.estoque) {
        showNotification(`‚ùå Estoque insuficiente! Dispon√≠vel: ${produto.estoque}`, 'warning');
        return;
    }
    
    // Atualizar quantidade
    item.quantidade = newQuantity;
    item.total = item.quantidade * item.preco;
    
    updateCart();
    showNotification(`üîÑ ${produto.nome}: ${item.quantidade} unidades`, 'info');
};

window.removeCartItem = function(index) {
    if (index >= 0 && index < carrinho.length) {
        const removedItem = carrinho[index];
        carrinho.splice(index, 1);
        updateCart();
        showNotification(`üóëÔ∏è ${removedItem.nome} removido do carrinho`, 'info');
    }
};

function clearCart() {
    if (carrinho.length === 0) {
        showNotification('‚ÑπÔ∏è Carrinho j√° est√° vazio', 'info');
        return;
    }
    
    if (confirm(`Deseja limpar todo o carrinho? (${carrinho.length} itens)`)) {
        carrinho = [];
        updateCart();
        showNotification('üßπ Carrinho limpo com sucesso!', 'success');
    }
}

// ===== PRODUTOS PARA VENDA =====
async function loadProductsForSale() {
    try {
        const productsGrid = document.getElementById('productsGrid');
        
        if (!Array.isArray(produtos) || produtos.length === 0) {
            productsGrid.innerHTML = `
                <div style="
                    text-align: center; 
                    padding: 40px; 
                    color: var(--gray); 
                    grid-column: 1 / -1;
                    background: white;
                    border-radius: 15px;
                    box-shadow: var(--shadow);
                ">
                    <i class="fas fa-ice-cream" style="font-size: 60px; opacity: 0.3;"></i>
                    <p style="margin-top: 15px; font-size: 18px;">Nenhum produto dispon√≠vel</p>
                    <p style="font-size: 14px; opacity: 0.7;">Cadastre produtos na aba "Produtos"</p>
                </div>
            `;
            return;
        }
        
        const produtosAtivos = produtos.filter(p => p.ativo && p.estoque > 0);
        
        if (produtosAtivos.length === 0) {
            productsGrid.innerHTML = `
                <div style="
                    text-align: center; 
                    padding: 40px; 
                    color: var(--warning); 
                    grid-column: 1 / -1;
                    background: white;
                    border-radius: 15px;
                    box-shadow: var(--shadow);
                ">
                    <i class="fas fa-exclamation-triangle" style="font-size: 60px; opacity: 0.3;"></i>
                    <p style="margin-top: 15px; font-size: 18px;">Nenhum produto ativo com estoque</p>
                    <p style="font-size: 14px; opacity: 0.7;">Ative produtos ou adicione estoque</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        produtosAtivos.forEach(produto => {
            const cor = produto.cor || '#36B5B0';
            const emoji = produto.emoji || 'üç¶';
            const estoque = produto.estoque;
            const estoqueBaixo = estoque <= 10;
            
            html += `
                <div class="flavor-card" 
                     onclick="addToCart(${produto.id})" 
                     style="
                         border-color: ${cor};
                         cursor: pointer;
                         position: relative;
                         ${estoqueBaixo ? 'border: 2px solid var(--warning);' : ''}
                     ">
                    ${estoqueBaixo ? `
                        <div style="
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: var(--warning);
                            color: white;
                            padding: 3px 8px;
                            border-radius: 10px;
                            font-size: 10px;
                            font-weight: bold;
                        ">
                            <i class="fas fa-exclamation-circle"></i> BAIXO
                        </div>
                    ` : ''}
                    
                    <div style="font-size: 50px; text-align: center; margin-bottom: 15px;">
                        ${emoji}
                    </div>
                    
                    <h3 style="
                        font-size: 18px; 
                        font-weight: 800; 
                        margin-bottom: 10px; 
                        color: var(--dark); 
                        text-align: center;
                        height: 45px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        ${produto.nome}
                    </h3>
                    
                    <p style="
                        color: var(--gray); 
                        font-size: 14px; 
                        margin-bottom: 15px; 
                        text-align: center;
                        height: 40px;
                        overflow: hidden;
                    ">
                        ${produto.descricao || 'Sem descri√ß√£o'}
                    </p>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 24px; font-weight: 900; color: ${cor};">
                            R$ ${formatPrice(produto.preco)}
                        </div>
                        <div style="
                            font-size: 14px; 
                            color: ${estoqueBaixo ? 'var(--warning)' : 'var(--success)'};
                            background: ${estoqueBaixo ? '#fff3cd' : '#e8f5e9'};
                            padding: 4px 8px;
                            border-radius: 15px;
                            font-weight: 700;
                        ">
                            <i class="fas fa-box"></i> ${estoque}
                        </div>
                    </div>
                    
                    <button style="
                        width: 100%;
                        margin-top: 15px;
                        padding: 10px;
                        background: ${cor};
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-weight: 700;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-cart-plus"></i>
                        Adicionar
                    </button>
                </div>
            `;
        });
        
        productsGrid.innerHTML = html;
        
    } catch (error) {
        console.error('Erro ao carregar produtos para venda:', error);
        const productsGrid = document.getElementById('productsGrid');
        if (productsGrid) {
            productsGrid.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--danger); grid-column: 1 / -1;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 50px;"></i>
                    <p style="margin-top: 10px;">Erro ao carregar produtos</p>
                </div>
            `;
        }
    }
}

// ===== SISTEMA DE FIADOS =====
async function carregarFiados() {
    try {
        showNotification('üîÑ Carregando fiados...', 'info');
        
        fiados = await neonAPI('get_fiados');
        const lista = document.getElementById('fiadosList');
        
        if (!Array.isArray(fiados) || fiados.length === 0) {
            lista.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-hand-holding-usd" style="font-size: 50px; opacity: 0.3;"></i>
                    <p style="margin-top: 10px; font-size: 16px;">Nenhum fiado registrado</p>
                    <p style="font-size: 14px; opacity: 0.7;">Clique em "Novo Fiado" para adicionar</p>
                </div>
            `;
            calcularResumoFiados();
            return;
        }
        
        calcularResumoFiados(fiados);
        
        let html = '';
        fiados.forEach((fiado) => {
            const clienteNome = fiado.cliente_nome || fiado.nome_cliente || 'Cliente';
            const telefone = fiado.cliente_telefone || fiado.telefone || 'N√£o informado';
            const valorTotal = fiado.valor_total || 0;
            const valorPago = fiado.valor_pago || 0;
            const dataVencimento = fiado.data_vencimento || fiado.prazo_pagamento;
            const status = fiado.status || 'pendente';
            const observacoes = fiado.observacoes || '';
            const saldo = valorTotal - valorPago;
            
            const estaAtrasado = () => {
                if (status === 'pago') return false;
                if (!dataVencimento) return false;
                const prazoDate = new Date(dataVencimento);
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                return prazoDate < hoje;
            };
            
            const atrasado = estaAtrasado();
            const statusFinal = atrasado ? 'atrasado' : status;
            
            const statusClass = {
                'pendente': 'background: #fff3cd; color: #856404;',
                'pago': 'background: #d4edda; color: #155724;',
                'parcial': 'background: #d1ecf1; color: #0c5460;',
                'atrasado': 'background: #f8d7da; color: #721c24;'
            }[statusFinal] || '';
            
            html += `
                <div style="
                    background: white; 
                    border-radius: 10px; 
                    padding: 20px; 
                    margin-bottom: 15px; 
                    border-left: 4px solid ${atrasado ? '#dc3545' : '#36B5B0'};
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h4 style="font-size: 16px; color: var(--dark); margin-bottom: 5px; font-weight: 700;">
                                ${clienteNome}
                            </h4>
                            <p style="font-size: 12px; color: var(--gray); margin-bottom: 3px;">
                                <i class="fas fa-phone"></i> ${telefone}
                            </p>
                            ${observacoes ? `
                                <p style="font-size: 12px; color: var(--gray); font-style: italic;">
                                    <i class="fas fa-sticky-note"></i> ${observacoes}
                                </p>
                            ` : ''}
                        </div>
                        <div style="text-align: right;">
                            <span style="
                                padding: 4px 12px; 
                                border-radius: 15px; 
                                font-size: 11px; 
                                font-weight: 700;
                                ${statusClass}
                            ">
                                ${atrasado ? '‚è∞ ATRASADO' : statusFinal.toUpperCase()}
                            </span>
                            <p style="font-size: 12px; color: var(--gray); margin-top: 8px;">
                                <i class="fas fa-calendar-day"></i> Vence: ${formatarData(dataVencimento)}
                            </p>
                        </div>
                    </div>
                    
                    <div style="
                        background: #f8f9fa; 
                        padding: 15px; 
                        border-radius: 8px; 
                        margin-bottom: 15px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 14px; color: var(--dark);">Valor Total:</span>
                            <span style="font-weight: 700; font-size: 15px;">R$ ${formatPrice(valorTotal)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 14px; color: var(--dark);">Valor Pago:</span>
                            <span style="color: var(--success); font-weight: 700; font-size: 15px;">
                                R$ ${formatPrice(valorPago)}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px dashed #dee2e6;">
                            <span style="font-size: 14px; color: var(--dark); font-weight: 700;">Saldo Devedor:</span>
                            <span style="
                                color: ${saldo > 0 ? 'var(--danger)' : 'var(--success)'}; 
                                font-weight: 900; 
                                font-size: 16px;
                            ">
                                R$ ${formatPrice(saldo)}
                            </span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="registrarPagamento(${fiado.id})" 
                                style="
                                    flex: 1; 
                                    padding: 10px; 
                                    font-size: 13px; 
                                    background: var(--success); 
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 700;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                    transition: all 0.3s ease;
                                ">
                            <i class="fas fa-money-bill-wave"></i> Registrar Pagamento
                        </button>
                        <button onclick="editarFiado(${fiado.id})" 
                                style="
                                    padding: 10px 15px; 
                                    border: none; 
                                    border-radius: 8px; 
                                    background: var(--primary); 
                                    color: white; 
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="excluirFiado(${fiado.id})" 
                                style="
                                    padding: 10px 15px; 
                                    border: none; 
                                    border-radius: 8px; 
                                    background: var(--danger); 
                                    color: white; 
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        lista.innerHTML = html;
        
        showNotification(`‚úÖ ${fiados.length} fiados carregados`, 'success');
        
    } catch (error) {
        console.error('Erro ao carregar fiados:', error);
        showNotification('‚ùå Erro ao carregar fiados', 'error');
        
        const lista = document.getElementById('fiadosList');
        if (lista) {
            lista.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 50px;"></i>
                    <p style="margin-top: 10px;">Erro ao carregar fiados</p>
                    <p style="font-size: 14px; opacity: 0.7;">${error.message}</p>
                </div>
            `;
        }
    }
}

function calcularResumoFiados(fiadosList = []) {
    const totalReceber = fiadosList.reduce((sum, f) => sum + ((f.valor_total || 0) - (f.valor_pago || 0)), 0);
    
    const clientesAtraso = fiadosList.filter(f => {
        if (f.status === 'pago') return false;
        const prazo = new Date(f.data_vencimento || f.prazo_pagamento);
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        return prazo < hoje;
    }).length;
    
    const recebidoMes = fiadosList.reduce((sum, f) => {
        // Simula√ß√£o: considerar 30% dos fiados pagos como recebido no m√™s
        return sum + (f.valor_pago || 0) * 0.3;
    }, 0);
    
    // Atualizar elementos na p√°gina
    const totalReceberEl = document.getElementById('totalReceber');
    const recebidoMesEl = document.getElementById('recebidoMes');
    const clientesAtrasoEl = document.getElementById('clientesAtraso');
    const fiadosAtivosEl = document.getElementById('fiadosAtivos');
    
    if (totalReceberEl) {
        totalReceberEl.textContent = `R$ ${formatPrice(totalReceber)}`;
    }
    if (recebidoMesEl) {
        recebidoMesEl.textContent = `R$ ${formatPrice(recebidoMes)}`;
    }
    if (clientesAtrasoEl) {
        clientesAtrasoEl.textContent = clientesAtraso;
    }
    if (fiadosAtivosEl) {
        fiadosAtivosEl.textContent = fiadosList.filter(f => f.status !== 'pago').length;
    }
}

// ===== RELAT√ìRIOS =====
async function loadReports() {
    try {
        const reportContent = document.getElementById('reportContent');
        
        // Mostrar loading
        reportContent.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--gray);">
                <i class="fas fa-spinner fa-spin" style="font-size: 50px;"></i>
                <p style="margin-top: 20px; font-size: 16px;">Gerando relat√≥rio...</p>
                <p style="font-size: 14px; opacity: 0.7;">Isso pode levar alguns segundos</p>
            </div>
        `;
        
        // Coletar dados
        const [vendasHoje, produtosList, fiadosList] = await Promise.all([
            neonAPI('get_vendas_recentes').catch(() => []),
            neonAPI('get_produtos').catch(() => []),
            neonAPI('get_fiados').catch(() => [])
        ]);
        
        // Calcular estat√≠sticas
        const totalVendas = Array.isArray(vendasHoje) ? vendasHoje.length : 0;
        const totalFaturamento = Array.isArray(vendasHoje) ? 
            vendasHoje.reduce((sum, v) => sum + (parseFloat(v.total) || 0), 0) : 0;
        const totalProdutos = Array.isArray(produtosList) ? produtosList.length : 0;
        const totalFiados = Array.isArray(fiadosList) ? fiadosList.length : 0;
        
        // Calcular faturamento por forma de pagamento
        const pagamentos = {};
        if (Array.isArray(vendasHoje)) {
            vendasHoje.forEach(v => {
                const tipo = v.pagamento || 'dinheiro';
                pagamentos[tipo] = (pagamentos[tipo] || 0) + (parseFloat(v.total) || 0);
            });
        }
        
        // Gerar HTML do relat√≥rio
        reportContent.innerHTML = `
            <div>
                <div style="
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center;
                    margin-bottom: 25px;
                    padding-bottom: 15px;
                    border-bottom: 2px solid var(--primary);
                ">
                    <h3 style="color: var(--dark); font-size: 22px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-bar"></i> Relat√≥rio Consolidado
                    </h3>
                    <div style="font-size: 14px; color: var(--gray);">
                        ${new Date().toLocaleDateString('pt-BR', { 
                            day: '2-digit', 
                            month: 'long', 
                            year: 'numeric' 
                        })}
                    </div>
                </div>
                
                <!-- Estat√≠sticas -->
                <div style="
                    display: grid; 
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
                    gap: 15px; 
                    margin-bottom: 30px;
                ">
                    <div style="
                        background: linear-gradient(135deg, #36B5B0, #2A9D8F); 
                        padding: 20px; 
                        border-radius: 12px; 
                        text-align: center;
                        color: white;
                        box-shadow: 0 5px 15px rgba(54, 181, 176, 0.3);
                    ">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">VENDAS HOJE</div>
                        <div style="font-size: 32px; font-weight: 900;">${totalVendas}</div>
                    </div>
                    
                    <div style="
                        background: linear-gradient(135deg, #4CAF50, #2E7D32); 
                        padding: 20px; 
                        border-radius: 12px; 
                        text-align: center;
                        color: white;
                        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
                    ">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">FATURAMENTO</div>
                        <div style="font-size: 32px; font-weight: 900;">R$ ${formatPrice(totalFaturamento)}</div>
                    </div>
                    
                    <div style="
                        background: linear-gradient(135deg, #FF9800, #F57C00); 
                        padding: 20px; 
                        border-radius: 12px; 
                        text-align: center;
                        color: white;
                        box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
                    ">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">PRODUTOS</div>
                        <div style="font-size: 32px; font-weight: 900;">${totalProdutos}</div>
                    </div>
                    
                    <div style="
                        background: linear-gradient(135deg, #F44336, #D32F2F); 
                        padding: 20px; 
                        border-radius: 12px; 
                        text-align: center;
                        color: white;
                        box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
                    ">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">FIADOS</div>
                        <div style="font-size: 32px; font-weight: 900;">${totalFiados}</div>
                    </div>
                </div>
                
                <!-- Formas de Pagamento -->
                <div style="
                    background: #f8f9fa; 
                    padding: 20px; 
                    border-radius: 15px; 
                    margin-bottom: 20px;
                    border: 1px solid #e9ecef;
                ">
                    <h4 style="color: var(--dark); margin-bottom: 15px; font-size: 18px;">
                        <i class="fas fa-credit-card"></i> Faturamento por Forma de Pagamento
                    </h4>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${Object.entries(pagamentos).map(([tipo, valor]) => {
                            const tipoNome = {
                                'dinheiro': 'üíµ Dinheiro',
                                'cartao': 'üí≥ Cart√£o',
                                'pix': 'üì± PIX',
                                'fiado': 'üìù Fiado'
                            }[tipo] || tipo;
                            
                            const porcentagem = totalFaturamento > 0 ? ((valor / totalFaturamento) * 100).toFixed(1) : 0;
                            
                            return `
                                <div style="
                                    display: flex; 
                                    justify-content: space-between; 
                                    align-items: center;
                                    padding: 12px 15px; 
                                    background: white; 
                                    border-radius: 10px;
                                    border-left: 4px solid var(--primary);
                                ">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 20px;">${tipoNome.split(' ')[0]}</span>
                                        <span style="font-weight: 700; color: var(--dark);">${tipoNome.split(' ')[1] || ''}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 900; font-size: 16px; color: var(--dark);">
                                            R$ ${formatPrice(valor)}
                                        </div>
                                        <div style="font-size: 12px; color: var(--gray);">
                                            ${porcentagem}% do total
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Resumo -->
                <div style="
                    background: #e8f5e9; 
                    padding: 20px; 
                    border-radius: 15px; 
                    border: 1px solid #c8e6c9;
                ">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="
                            background: #4CAF50; 
                            color: white; 
                            width: 50px; 
                            height: 50px; 
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                        ">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <p style="color: #155724; font-weight: 700; font-size: 16px; margin-bottom: 5px;">
                                Relat√≥rio gerado com sucesso!
                            </p>
                            <p style="color: #388e3c; font-size: 14px;">
                                Dados atualizados em ${new Date().toLocaleTimeString('pt-BR')}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Erro ao gerar relat√≥rio:', error);
        
        const reportContent = document.getElementById('reportContent');
        if (reportContent) {
            reportContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--warning);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 50px;"></i>
                    <p style="margin-top: 15px; font-size: 18px;">Erro ao gerar relat√≥rio</p>
                    <p style="font-size: 14px; opacity: 0.7; margin-top: 5px;">${error.message}</p>
                    <button onclick="loadReports()" 
                            style="
                                margin-top: 20px;
                                padding: 10px 20px;
                                background: var(--primary);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 700;
                                display: inline-flex;
                                align-items: center;
                                gap: 8px;
                            ">
                        <i class="fas fa-redo"></i>
                        Tentar Novamente
                    </button>
                </div>
            `;
        }
    }
}

// ===== FUN√á√ïES DE NAVEGA√á√ÉO E UTILIT√ÅRIAS =====
window.navigateTo = function(pageId) {
    const tab = document.querySelector(`.nav-tab[data-page="${pageId}"]`);
    if (tab) {
        tab.click();
    }
};

window.syncData = async function() {
    try {
        const syncButton = document.getElementById('syncButton');
        const originalText = syncButton.innerHTML;
        
        // Mostrar loading no bot√£o
        syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';
        syncButton.disabled = true;
        
        showNotification('üîÑ Sincronizando dados...', 'info');
        
        // Atualizar todos os dados
        produtos = await neonAPI('get_produtos');
        
        // Atualizar p√°ginas vis√≠veis
        const currentPage = document.querySelector('.page.active')?.id;
        
        if (currentPage === 'dashboard') {
            await loadDashboard();
        } else if (currentPage === 'vendas') {
            await loadProductsForSale();
        } else if (currentPage === 'fiados') {
            await carregarFiados();
        }
        
        // Restaurar bot√£o
        syncButton.innerHTML = originalText;
        syncButton.disabled = false;
        
        showNotification('‚úÖ Dados sincronizados com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o:', error);
        
        // Restaurar bot√£o mesmo em caso de erro
        const syncButton = document.getElementById('syncButton');
        if (syncButton) {
            syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Sincronizar';
            syncButton.disabled = false;
        }
        
        showNotification('‚ùå Erro na sincroniza√ß√£o', 'error');
    }
};

// ===== INICIALIZA√á√ÉO DO SISTEMA =====
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Sistema Chop Manager PRO iniciando...');
    
    // 1. Atualizar data e hora
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // 2. Configurar navega√ß√£o entre abas
    const tabs = document.querySelectorAll('.nav-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', async function() {
            const pageId = this.dataset.page;
            
            // Remover classe active de todas as tabs
            tabs.forEach(t => t.classList.remove('active'));
            
            // Adicionar classe active √† tab clicada
            this.classList.add('active');
            
            // Esconder todas as p√°ginas
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostrar a p√°gina correspondente
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Carregar dados espec√≠ficos da p√°gina
                try {
                    if (pageId === 'dashboard') {
                        await loadDashboard();
                    } else if (pageId === 'vendas') {
                        await loadProductsForSale();
                    } else if (pageId === 'fiados') {
                        await carregarFiados();
                    } else if (pageId === 'relatorios') {
                        // Relat√≥rios ser√° carregado quando o bot√£o for clicado
                    }
                } catch (error) {
                    console.error(`Erro ao carregar p√°gina ${pageId}:`, error);
                }
            }
        });
    });
    
    // 3. Configurar eventos dos bot√µes
    document.getElementById('clearCart')?.addEventListener('click', clearCart);
    document.getElementById('finalizeSale')?.addEventListener('click', finalizeSale);
    document.getElementById('generateReportBtn')?.addEventListener('click', loadReports);
    document.getElementById('backupBtn')?.addEventListener('click', () => {
        showNotification('üíæ Backup em desenvolvimento', 'info');
    });
    
    // 4. Configurar bot√µes do dashboard
    document.getElementById('btnVerTodas')?.addEventListener('click', () => {
        navigateTo('relatorios');
    });
    
    document.getElementById('btnVerTodosProdutos')?.addEventListener('click', () => {
        navigateTo('produtos');
    });
    
    document.getElementById('btnReporEstoque')?.addEventListener('click', () => {
        navigateTo('produtos');
    });
    
    // 5. Configurar eventos de formul√°rio de pagamento
    const paymentOptions = document.querySelectorAll('input[name="payment"]');
    paymentOptions.forEach(option => {
        option.addEventListener('change', function() {
            const selectedPayment = this.value;
            showNotification(`üí∞ Forma de pagamento selecionada: ${selectedPayment.toUpperCase()}`, 'info');
        });
    });
    
    // 6. Testar conex√£o e carregar dados iniciais
    try {
        showNotification('üîå Conectando ao servidor...', 'info');
        const isConnected = await testConnection();
        
        if (isConnected) {
            showNotification('‚úÖ Conectado com sucesso!', 'success');
            
            // Carregar produtos
            produtos = await neonAPI('get_produtos');
            console.log(`üì¶ ${produtos.length} produtos carregados`);
            
            // Inicializar carrinho
            updateCart();
            
            // Carregar dashboard inicial
            await loadDashboard();
            
        } else {
            showNotification('‚ùå Servidor offline. Usando modo offline.', 'error');
            
            // Carregar dados locais ou mostrar mensagem
            document.getElementById('dashboard').innerHTML = `
                <div style="text-align: center; padding: 50px; color: var(--danger);">
                    <i class="fas fa-wifi-slash" style="font-size: 60px;"></i>
                    <h2 style="margin: 20px 0;">Servidor Offline</h2>
                    <p>N√£o foi poss√≠vel conectar ao servidor.</p>
                    <p style="font-size: 14px; opacity: 0.7;">Verifique sua conex√£o com a internet.</p>
                    <button onclick="syncData()" 
                            style="
                                margin-top: 20px;
                                padding: 12px 25px;
                                background: var(--primary);
                                color: white;
                                border: none;
                                border-radius: 10px;
                                cursor: pointer;
                                font-weight: 700;
                                display: inline-flex;
                                align-items: center;
                                gap: 10px;
                            ">
                        <i class="fas fa-redo"></i>
                        Tentar Reconectar
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showNotification('‚ö†Ô∏è Erro na inicializa√ß√£o do sistema', 'warning');
    }
    
    // 7. Configurar atalhos de teclado
    document.addEventListener('keydown', function(event) {
        // Ctrl + S para sincronizar
        if (event.ctrlKey && event.key === 's') {
            event.preventDefault();
            syncData();
        }
        
        // Esc para limpar carrinho (apenas na p√°gina de vendas)
        if (event.key === 'Escape' && document.getElementById('vendas')?.classList.contains('active')) {
            clearCart();
        }
    });
    
    console.log('‚úÖ Sistema inicializado com sucesso!');
});

// ===== FUN√á√ïES DE FIADOS (PLACEHOLDER/EM DESENVOLVIMENTO) =====
function abrirModalFiado(fiado = null) {
    showNotification('üìù Funcionalidade de fiados em desenvolvimento', 'info');
    // Implementa√ß√£o futura: abrir modal para criar/editar fiado
}

function abrirModalFiadoParaVenda(total) {
    showNotification('üí∞ Para vendas fiadas, use a aba "Fiados"', 'info');
    navigateTo('fiados');
}

function fecharModalFiado() {
    const modal = document.getElementById('fiadoModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

async function registrarPagamento(fiadoId) {
    showNotification('üíµ Registro de pagamento em desenvolvimento', 'info');
    // Implementa√ß√£o futura: abrir modal para registrar pagamento
}

async function editarFiado(fiadoId) {
    showNotification('‚úèÔ∏è Edi√ß√£o de fiados em desenvolvimento', 'info');
    // Implementa√ß√£o futura: abrir modal para editar fiado
}

async function excluirFiado(fiadoId) {
    if (!confirm('Tem certeza que deseja excluir este fiado? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
    }
    
    try {
        showNotification('üóëÔ∏è Excluindo fiado...', 'info');
        
        await neonAPI('delete_fiado', { id: fiadoId });
        
        // Remover da lista local
        fiados = fiados.filter(f => f.id !== fiadoId);
        
        // Recarregar lista
        await carregarFiados();
        
        showNotification('‚úÖ Fiado exclu√≠do com sucesso!', 'success');
    } catch (error) {
        console.error('Erro ao excluir fiado:', error);
        showNotification('‚ùå Erro ao excluir fiado', 'error');
    }
}

// ===== FUN√á√ïES PARA OUTRAS P√ÅGINAS =====
async function loadAllProducts() {
    const productsList = document.getElementById('productsList');
    if (!productsList) return;
    
    try {
        productsList.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: var(--primary);"></i>
                <p style="margin-top: 15px; color: var(--gray);">Carregando produtos...</p>
            </div>
        `;
        
        const produtosAPI = await neonAPI('get_produtos');
        
        if (!Array.isArray(produtosAPI) || produtosAPI.length === 0) {
            productsList.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-ice-cream" style="font-size: 50px; opacity: 0.3;"></i>
                    <p style="margin-top: 15px; font-size: 18px;">Nenhum produto cadastrado</p>
                    <p style="font-size: 14px; opacity: 0.7;">Clique em "Novo Produto" para adicionar</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        produtosAPI.forEach(produto => {
            const cor = produto.cor || '#36B5B0';
            const emoji = produto.emoji || 'üç¶';
            const estoque = produto.estoque || 0;
            const estoqueStatus = estoque === 0 ? 'ESGOTADO' : 
                                estoque <= 10 ? 'BAIXO' : 'OK';
            const estoqueColor = estoque === 0 ? 'var(--danger)' : 
                               estoque <= 10 ? 'var(--warning)' : 'var(--success)';
            
            html += `
                <div class="flavor-card" style="border-color: ${cor}; position: relative;">
                    ${!produto.ativo ? `
                        <div style="
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: var(--danger);
                            color: white;
                            padding: 3px 8px;
                            border-radius: 10px;
                            font-size: 10px;
                            font-weight: bold;
                        ">
                            <i class="fas fa-ban"></i> INATIVO
                        </div>
                    ` : ''}
                    
                    <div style="font-size: 50px; text-align: center; margin-bottom: 15px;">
                        ${emoji}
                    </div>
                    
                    <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 10px; color: var(--dark); text-align: center;">
                        ${produto.nome}
                    </h3>
                    
                    <p style="color: var(--gray); font-size: 14px; margin-bottom: 10px; text-align: center; height: 60px; overflow: hidden;">
                        ${produto.descricao || 'Sem descri√ß√£o'}
                    </p>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 20px; font-weight: 900; color: ${cor};">
                            R$ ${formatPrice(produto.preco)}
                        </div>
                        <div style="
                            font-size: 12px; 
                            color: ${estoqueColor};
                            background: ${estoque === 0 ? '#f8d7da' : 
                                       estoque <= 10 ? '#fff3cd' : '#d4edda'};
                            padding: 4px 8px;
                            border-radius: 15px;
                            font-weight: 700;
                        ">
                            <i class="fas fa-box"></i> ${estoque} (${estoqueStatus})
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button style="
                            flex: 1; 
                            padding: 8px; 
                            background: var(--primary); 
                            color: white; 
                            border: none; 
                            border-radius: 8px; 
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 5px;
                        ">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button style="
                            flex: 1; 
                            padding: 8px; 
                            background: var(--warning); 
                            color: white; 
                            border: none; 
                            border-radius: 8px; 
                            cursor: pointer;
                            font-weight: 700;
                            font-size: 12px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 5px;
                        ">
                            <i class="fas fa-chart-line"></i> Estat√≠sticas
                        </button>
                    </div>
                </div>
            `;
        });
        
        productsList.innerHTML = html;
        
    } catch (error) {
        console.error('Erro ao carregar todos os produtos:', error);
        productsList.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--danger);">
                <i class="fas fa-exclamation-triangle" style="font-size: 50px;"></i>
                <p style="margin-top: 15px;">Erro ao carregar produtos</p>
                <p style="font-size: 14px; opacity: 0.7;">${error.message}</p>
            </div>
        `;
    }
}

async function loadConfigInfo() {
    try {
        const [produtosAPI, vendasAPI] = await Promise.all([
            neonAPI('get_produtos').catch(() => []),
            neonAPI('get_vendas_recentes').catch(() => [])
        ]);
        
        const totalProducts = Array.isArray(produtosAPI) ? produtosAPI.length : 0;
        const totalSales = Array.isArray(vendasAPI) ? vendasAPI.length : 0;
        const totalRevenue = Array.isArray(vendasAPI) ? 
            vendasAPI.reduce((sum, v) => sum + (parseFloat(v.total) || 0), 0) : 0;
        
        // Atualizar elementos se existirem
        const totalProductsEl = document.getElementById('totalProducts');
        const totalSalesEl = document.getElementById('totalSales');
        const totalRevenueEl = document.getElementById('totalRevenue');
        
        if (totalProductsEl) totalProductsEl.textContent = totalProducts;
        if (totalSalesEl) totalSalesEl.textContent = totalSales;
        if (totalRevenueEl) totalRevenueEl.textContent = `R$ ${formatPrice(totalRevenue)}`;
        
    } catch (error) {
        console.error('Erro ao carregar informa√ß√µes de configura√ß√£o:', error);
    }
}

// Exportar para PDF (placeholder)
function exportToPDF() {
    showNotification('üìÑ Exporta√ß√£o para PDF em desenvolvimento', 'info');
}

// Imprimir relat√≥rio
function printReport() {
    showNotification('üñ®Ô∏è Impress√£o em desenvolvimento', 'info');
}
</script>
</body>
</html> 
