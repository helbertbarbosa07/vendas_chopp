<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç¶ Chop Manager PRO - Sistema Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ... SEU CSS EXISTENTE (mantenha tudo igual) ... */
    </style>
</head>
<body>
    <!-- ... SEU HTML EXISTENTE (mantenha tudo igual) ... -->
    
    <script>
        // ===== CONFIGURA√á√ÉO SUPABASE =====
        // SUA_URL e SUA_CHAVE ser√£o preenchidas pelo sistema
        const SUPABASE_URL = '';
        const SUPABASE_ANON_KEY = '';
        
        let supabase = null;
        let carrinho = [];
        let charts = {};
        
        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Solicitar credenciais do Supabase
            await solicitarCredenciais();
            
            // Inicializar Supabase
            await initSupabase();
            
            // Inicializar data/hora
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Inicializar navega√ß√£o
            initNavigation();
            
            // Inicializar componentes
            initComponents();
            
            // Carregar dados iniciais
            await loadDashboard();
            await loadProductsForSale();
            await loadProductsList();
            initEmojiPicker();
            initPhotoUpload();
            
            // Configurar listeners
            document.getElementById('reportPeriod').addEventListener('change', function() {
                const customRange = document.getElementById('customDateRange');
                customRange.style.display = this.value === 'personalizado' ? 'flex' : 'none';
            });
            
            document.getElementById('productFilter').addEventListener('change', loadProductsList);
            document.getElementById('productSearch').addEventListener('input', loadProductsList);
        });
        
        // ===== FUN√á√ÉO PARA SOLICITAR CREDENCIAIS DO SUPABASE =====
        async function solicitarCredenciais() {
            // Verificar se j√° temos credenciais salvas
            const savedUrl = localStorage.getItem('supabase_url');
            const savedKey = localStorage.getItem('supabase_key');
            
            if (savedUrl && savedKey) {
                SUPABASE_URL = savedUrl;
                SUPABASE_ANON_KEY = savedKey;
                return;
            }
            
            // Se n√£o tem credenciais, mostrar modal
            const url = prompt('üîë Insira a URL do seu Supabase:');
            if (!url) {
                alert('√â necess√°rio configurar o Supabase para usar o sistema!');
                location.reload();
                return;
            }
            
            const key = prompt('üîê Insira a chave an√¥nima do seu Supabase:');
            if (!key) {
                alert('√â necess√°rio configurar o Supabase para usar o sistema!');
                location.reload();
                return;
            }
            
            // Salvar credenciais
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            
            SUPABASE_URL = url;
            SUPABASE_ANON_KEY = key;
            
            showNotification('‚úÖ Supabase configurado com sucesso!', 'success');
        }
        
        // ===== INICIALIZAR SUPABASE =====
        async function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Testar conex√£o
                const { data, error } = await supabase
                    .from('produtos')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    console.error('Erro ao conectar com Supabase:', error);
                    
                    // Tentar criar tabelas automaticamente
                    await criarTabelasSupabase();
                } else {
                    console.log('‚úÖ Conex√£o com Supabase estabelecida!');
                    showNotification('‚úÖ Conectado ao banco de dados', 'success');
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao inicializar Supabase:', error);
                showNotification('‚ùå Erro ao conectar com Supabase', 'error');
                return false;
            }
        }
        
        // ===== CRIAR TABELAS NO SUPABASE =====
        async function criarTabelasSupabase() {
            showNotification('üîÑ Criando estrutura do banco de dados...', 'info');
            
            // Nota: No Supabase, voc√™ precisa criar as tabelas via SQL ou interface web
            // Aqui vamos apenas mostrar as instru√ß√µes SQL
            
            const sqlInstructions = `
            -- 1. Criar tabela de produtos
            CREATE TABLE produtos (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                nome TEXT NOT NULL,
                descricao TEXT,
                preco DECIMAL(10,2) NOT NULL,
                estoque INTEGER DEFAULT 0,
                emoji TEXT DEFAULT 'üç¶',
                cor TEXT DEFAULT '#36B5B0',
                ativo BOOLEAN DEFAULT true,
                vendas INTEGER DEFAULT 0,
                categoria TEXT,
                foto TEXT,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()),
                updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW())
            );
            
            -- 2. Criar tabela de vendas
            CREATE TABLE vendas (
                id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                data DATE NOT NULL,
                hora TIME NOT NULL,
                itens JSONB NOT NULL,
                total DECIMAL(10,2) NOT NULL,
                pagamento TEXT NOT NULL,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW())
            );
            
            -- 3. Criar tabela de configura√ß√µes
            CREATE TABLE configuracoes (
                chave TEXT PRIMARY KEY,
                valor TEXT,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW())
            );
            
            -- 4. Inserir produtos iniciais
            INSERT INTO produtos (nome, descricao, preco, estoque, emoji, cor, categoria) VALUES
            ('Casquinha Chocolate', 'Casquinha tradicional de chocolate', 5.00, 50, 'üç´', '#8B4513', 'casquinha'),
            ('Casquinha Morango', 'Casquinha cremosa de morango', 5.00, 40, 'üçì', '#FF7BAC', 'casquinha'),
            ('Pote 500ml', 'Pote de sorvete 500ml', 15.00, 30, 'üç®', '#36B5B0', 'pote'),
            ('Milkshake', 'Milkshake cremoso', 12.00, 25, 'ü•§', '#FFD166', 'bebida');
            `;
            
            alert(`
            ‚ö†Ô∏è Configura√ß√£o do Banco de Dados ‚ö†Ô∏è
            
            Para usar o sistema, voc√™ precisa criar as tabelas no Supabase.
            
            Acesse seu projeto Supabase:
            1. V√° para SQL Editor
            2. Cole o SQL abaixo:
            
            ${sqlInstructions}
            
            3. Execute o SQL
            4. Recarregue esta p√°gina
            
            Ou contate o administrador do sistema.
            `);
            
            return false;
        }
        
        // ===== FUN√á√ïES CRUD SUPABASE =====
        
        // PRODUTOS
        async function salvarProduto(produto) {
            try {
                if (produto.id) {
                    // Atualizar produto existente
                    const { data, error } = await supabase
                        .from('produtos')
                        .update({
                            nome: produto.nome,
                            descricao: produto.descricao,
                            preco: produto.preco,
                            estoque: produto.estoque,
                            emoji: produto.emoji,
                            cor: produto.cor,
                            ativo: produto.ativo,
                            categoria: produto.categoria,
                            foto: produto.foto,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', produto.id)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    // Criar novo produto
                    const { data, error } = await supabase
                        .from('produtos')
                        .insert([{
                            nome: produto.nome,
                            descricao: produto.descricao,
                            preco: produto.preco,
                            estoque: produto.estoque,
                            emoji: produto.emoji,
                            cor: produto.cor,
                            ativo: produto.ativo,
                            vendas: 0,
                            categoria: produto.categoria || 'geral',
                            foto: produto.foto
                        }])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Erro ao salvar produto:', error);
                showNotification('‚ùå Erro ao salvar produto', 'error');
                return null;
            }
        }
        
        async function obterProduto(id) {
            try {
                const { data, error } = await supabase
                    .from('produtos')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Erro ao obter produto:', error);
                return null;
            }
        }
        
        async function obterTodosProdutos(filtro = {}) {
            try {
                let query = supabase.from('produtos').select('*');
                
                // Aplicar filtros
                if (filtro.ativos !== undefined) {
                    query = query.eq('ativo', filtro.ativos);
                }
                
                if (filtro.estoqueBaixo) {
                    query = query.lt('estoque', 10);
                }
                
                if (filtro.categoria) {
                    query = query.eq('categoria', filtro.categoria);
                }
                
                if (filtro.busca) {
                    query = query.or(`nome.ilike.%${filtro.busca}%,descricao.ilike.%${filtro.busca}%`);
                }
                
                // Ordenar por nome
                query = query.order('nome', { ascending: true });
                
                const { data, error } = await query;
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao obter produtos:', error);
                showNotification('‚ùå Erro ao carregar produtos', 'error');
                return [];
            }
        }
        
        async function excluirProduto(id) {
            try {
                const { error } = await supabase
                    .from('produtos')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                showNotification('‚ùå Erro ao excluir produto', 'error');
                return false;
            }
        }
        
        // VENDAS
        async function salvarVenda(venda) {
            try {
                // Primeiro, salvar a venda
                const { data: vendaSalva, error: vendaError } = await supabase
                    .from('vendas')
                    .insert([{
                        data: venda.data,
                        hora: venda.hora,
                        itens: venda.itens,
                        total: venda.total,
                        pagamento: venda.pagamento
                    }])
                    .select();
                
                if (vendaError) throw vendaError;
                
                // Atualizar estoque e contador de vendas de cada produto
                for (const item of venda.itens) {
                    // Obter produto atual
                    const { data: produto, error: produtoError } = await supabase
                        .from('produtos')
                        .select('*')
                        .eq('id', item.produtoId)
                        .single();
                    
                    if (produtoError) throw produtoError;
                    
                    // Atualizar produto
                    const { error: updateError } = await supabase
                        .from('produtos')
                        .update({
                            estoque: produto.estoque - item.quantidade,
                            vendas: (produto.vendas || 0) + item.quantidade,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', item.produtoId);
                    
                    if (updateError) throw updateError;
                }
                
                return vendaSalva[0];
            } catch (error) {
                console.error('Erro ao salvar venda:', error);
                showNotification('‚ùå Erro ao salvar venda', 'error');
                return null;
            }
        }
        
        async function obterVendas(filtro = {}) {
            try {
                let query = supabase.from('vendas').select('*');
                
                // Aplicar filtros de data
                if (filtro.dataInicio && filtro.dataFim) {
                    query = query.gte('data', filtro.dataInicio).lte('data', filtro.dataFim);
                } else if (filtro.data) {
                    query = query.eq('data', filtro.data);
                }
                
                // Filtrar por forma de pagamento
                if (filtro.pagamento) {
                    query = query.eq('pagamento', filtro.pagamento);
                }
                
                // Ordenar por data mais recente
                query = query.order('created_at', { ascending: false });
                
                const { data, error } = await query;
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao obter vendas:', error);
                return [];
            }
        }
        
        // CONFIGURA√á√ïES
        async function salvarConfig(chave, valor) {
            try {
                const { error } = await supabase
                    .from('configuracoes')
                    .upsert({ chave, valor }, { onConflict: 'chave' });
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Erro ao salvar configura√ß√£o:', error);
                return false;
            }
        }
        
        async function obterConfig(chave) {
            try {
                const { data, error } = await supabase
                    .from('configuracoes')
                    .select('valor')
                    .eq('chave', chave)
                    .single();
                
                if (error) throw error;
                return data?.valor || null;
            } catch (error) {
                console.error('Erro ao obter configura√ß√£o:', error);
                return null;
            }
        }
        
        // ===== FUN√á√ïES DO SISTEMA (ATUALIZADAS PARA SUPABASE) =====
        
        async function loadDashboard() {
            try {
                const hoje = new Date().toISOString().split('T')[0];
                const vendasHoje = await obterVendas({ data: hoje });
                
                // Calcular estat√≠sticas
                const faturamentoHoje = vendasHoje.reduce((sum, v) => sum + v.total, 0);
                const chopsHoje = vendasHoje.reduce((sum, v) => 
                    sum + v.itens.reduce((s, i) => s + i.quantidade, 0), 0);
                const mediaVenda = vendasHoje.length > 0 ? faturamentoHoje / vendasHoje.length : 0;
                
                const produtosAtivos = await obterTodosProdutos({ ativos: true });
                const estoqueBaixo = produtosAtivos.filter(p => p.estoque < 10).length;
                
                // Atualizar estat√≠sticas
                document.getElementById('todayRevenue').textContent = `R$ ${faturamentoHoje.toFixed(2)}`;
                document.getElementById('todayChops').textContent = chopsHoje;
                document.getElementById('avgSale').textContent = `R$ ${mediaVenda.toFixed(2)}`;
                document.getElementById('lowStock').textContent = estoqueBaixo;
                
                // Atualizar gr√°ficos
                updateCharts(vendasHoje, produtosAtivos);
                
                // Carregar √∫ltimas vendas
                loadRecentSales(vendasHoje);
                
                // Carregar produtos mais vendidos
                loadTopProducts(produtosAtivos);
                
                // Carregar estoque baixo
                loadLowStockProducts(produtosAtivos);
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                showNotification('Erro ao carregar dashboard', 'error');
            }
        }
        
        async function loadProductsForSale() {
            try {
                const container = document.getElementById('productsGrid');
                const produtosAtivos = await obterTodosProdutos({ ativos: true });
                const produtosDisponiveis = produtosAtivos.filter(p => p.estoque > 0);
                
                if (produtosDisponiveis.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--gray);">
                            <i class="fas fa-ice-cream" style="font-size: 50px; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 16px;">Nenhum produto dispon√≠vel para venda</p>
                            <button class="btn-primary" onclick="navigateTo('produtos')" style="margin-top: 15px;">
                                <i class="fas fa-plus"></i> Cadastrar Produto
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                produtosDisponiveis.forEach(produto => {
                    const card = document.createElement('div');
                    card.className = 'flavor-card';
                    
                    const photoHTML = produto.foto ? 
                        `<img src="${produto.foto}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; margin-bottom: 10px;">` :
                        `<div style="font-size: 40px; margin-bottom: 10px;">${produto.emoji}</div>`;
                    
                    card.innerHTML = `
                        ${photoHTML}
                        <div style="font-size: 18px; font-weight: 800; color: var(--dark); margin-bottom: 8px;">${produto.nome}</div>
                        <div style="color: var(--gray); font-size: 13px; margin-bottom: 10px; min-height: 40px;">${produto.descricao}</div>
                        <div style="font-size: 24px; font-weight: 900; color: var(--primary); margin: 10px 0;">R$ ${produto.preco.toFixed(2)}</div>
                        <div style="padding: 6px 12px; background: ${produto.estoque < 10 ? '#fff3cd' : '#f8f9fa'}; border-radius: 15px; color: ${produto.estoque < 10 ? '#856404' : 'var(--gray)'}; font-size: 13px; display: inline-block;">
                            ${produto.estoque} unidades
                        </div>
                        <button class="btn-primary" style="margin-top: 15px; padding: 10px; font-size: 14px; width: 100%;" 
                                data-id="${produto.id}" ${produto.estoque === 0 ? 'disabled' : ''}>
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    `;
                    
                    card.querySelector('button').addEventListener('click', () => addToCart(produto));
                    container.appendChild(card);
                });
                
                updateCart();
            } catch (error) {
                console.error('Erro ao carregar produtos para venda:', error);
            }
        }
        
        async function loadProductsList() {
            try {
                const container = document.getElementById('productsList');
                const filter = document.getElementById('productFilter').value;
                const search = document.getElementById('productSearch').value.toLowerCase();
                
                let filtro = {};
                
                switch(filter) {
                    case 'estoque-baixo': 
                        filtro.estoqueBaixo = true;
                        break;
                    case 'ativos': 
                        filtro.ativos = true;
                        break;
                    case 'inativos': 
                        filtro.ativos = false;
                        break;
                }
                
                if (search) {
                    filtro.busca = search;
                }
                
                let produtosFiltrados = await obterTodosProdutos(filtro);
                
                if (filter === 'mais-vendidos') {
                    produtosFiltrados.sort((a, b) => (b.vendas || 0) - (a.vendas || 0));
                }
                
                if (produtosFiltrados.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--gray);">
                            <i class="fas fa-ice-cream" style="font-size: 50px; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-size: 16px;">Nenhum produto encontrado</p>
                            <button class="btn-primary" onclick="openProductModal()" style="margin-top: 15px;">
                                <i class="fas fa-plus"></i> Cadastrar Produto
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                produtosFiltrados.forEach(produto => {
                    const estoqueClasse = produto.estoque < 10 ? 'stock-low' : '';
                    const statusClass = produto.ativo ? 'success' : 'danger';
                    const statusText = produto.ativo ? 'Ativo' : 'Inativo';
                    
                    const photoHTML = produto.foto ? 
                        `<img src="${produto.foto}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-bottom: 10px;">` :
                        `<div style="font-size: 40px; margin-bottom: 10px;">${produto.emoji}</div>`;
                    
                    const card = document.createElement('div');
                    card.className = 'flavor-card';
                    card.innerHTML = `
                        ${photoHTML}
                        <div style="font-size: 18px; font-weight: 800; color: var(--dark); margin-bottom: 8px;">${produto.nome}</div>
                        <div style="color: var(--gray); font-size: 13px; margin-bottom: 10px;">${produto.descricao}</div>
                        <div style="font-size: 22px; font-weight: 900; color: var(--primary); margin: 10px 0;">R$ ${produto.preco.toFixed(2)}</div>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                            <div style="padding: 6px 12px; background: ${estoqueClasse ? '#fff3cd' : '#f8f9fa'}; border-radius: 15px; color: ${estoqueClasse ? '#856404' : 'var(--gray)'}; font-size: 12px;">
                                ${produto.estoque} unidades
                            </div>
                            <div style="padding: 6px 12px; background: ${statusClass === 'success' ? '#e8f5e9' : '#ffebee'}; border-radius: 15px; color: ${statusClass === 'success' ? '#2e7d32' : '#d32f2f'}; font-size: 12px;">
                                ${statusText}
                            </div>
                        </div>
                        <div style="padding: 6px 12px; background: #e3f2fd; border-radius: 15px; color: #1565c0; font-size: 12px; margin-bottom: 10px;">
                            Vendas: ${produto.vendas || 0}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px;">
                            <button class="btn-primary" style="background: var(--secondary); padding: 8px; font-size: 12px;" onclick="editProduct(${produto.id})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-primary" style="background: var(--danger); padding: 8px; font-size: 12px;" onclick="deleteProduct(${produto.id})">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Erro ao carregar lista de produtos:', error);
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: var(--gray);">
                        <i class="fas fa-exclamation-circle" style="font-size: 50px; margin-bottom: 15px; color: var(--danger);"></i>
                        <p style="font-size: 16px;">Erro ao carregar produtos</p>
                    </div>
                `;
            }
        }
        
        async function finalizeSale() {
            try {
                if (carrinho.length === 0) return;
                
                const formaPagamento = document.querySelector('input[name="payment"]:checked').value;
                const total = carrinho.reduce((sum, item) => sum + item.total, 0);
                
                const novaVenda = {
                    data: new Date().toISOString().split('T')[0],
                    hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                    itens: carrinho.map(item => ({
                        produtoId: item.produtoId,
                        nome: item.nome,
                        quantidade: item.quantidade,
                        preco: item.preco
                    })),
                    total: total,
                    pagamento: formaPagamento
                };
                
                await salvarVenda(novaVenda);
                
                showNotification(`‚úÖ Venda realizada! R$ ${total.toFixed(2)}`, 'success');
                
                carrinho = [];
                updateCart();
                
                // Atualizar dashboard
                await loadDashboard();
                await loadProductsForSale();
                
                // Voltar para dashboard ap√≥s 1 segundo
                setTimeout(() => {
                    navigateTo('dashboard');
                }, 1000);
            } catch (error) {
                console.error('Erro ao finalizar venda:', error);
                showNotification('Erro ao finalizar venda!', 'error');
            }
        }
        
        // ===== FUN√á√ïES DE GEST√ÉO DE ARQUIVOS (FOTOS) =====
        async function uploadFoto(file) {
            try {
                // Criar nome √∫nico para o arquivo
                const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
                
                // Fazer upload para o Supabase Storage
                const { data, error } = await supabase.storage
                    .from('produtos') // Bucket precisa existir
                    .upload(fileName, file);
                
                if (error) {
                    // Se o bucket n√£o existir, usar base64
                    console.warn('Bucket n√£o encontrado, usando base64:', error);
                    return await fileToBase64(file);
                }
                
                // Obter URL p√∫blica
                const { data: urlData } = supabase.storage
                    .from('produtos')
                    .getPublicUrl(fileName);
                
                return urlData.publicUrl;
            } catch (error) {
                console.error('Erro no upload de foto:', error);
                return await fileToBase64(file); // Fallback para base64
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // ===== FUN√á√ïES UTILIT√ÅRIAS =====
        function updateDateTime() {
            try {
                const now = new Date();
                const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('currentDate').textContent = now.toLocaleDateString('pt-BR', optionsDate);
                
                const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR', optionsTime);
            } catch (error) {
                console.error('Erro ao atualizar data/hora:', error);
            }
        }
        
        function showNotification(mensagem, tipo = 'info') {
            try {
                const notification = document.getElementById('notification');
                notification.textContent = mensagem;
                notification.className = `notification ${tipo} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            } catch (error) {
                console.error('Erro ao mostrar notifica√ß√£o:', error);
            }
        }
        
        // ===== FUN√á√ïES GLOBAIS =====
        window.navigateTo = navigateTo;
        
        window.editProduct = async function(id) {
            try {
                const produto = await obterProduto(id);
                if (produto) openProductModal(produto);
            } catch (error) {
                console.error('Erro ao editar produto:', error);
            }
        };
        
        window.deleteProduct = async function(id) {
            try {
                const produto = await obterProduto(id);
                if (produto && confirm(`Tem certeza que deseja excluir "${produto.nome}"?`)) {
                    await excluirProduto(id);
                    showNotification('‚úÖ Produto exclu√≠do!', 'success');
                    await loadProductsList();
                    await loadProductsForSale();
                    await loadDashboard();
                }
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                showNotification('Erro ao excluir produto!', 'error');
            }
        };
        
        // ... (mantenha as outras fun√ß√µes do seu c√≥digo original, como initNavigation, initComponents, etc.)
        
        // Adicione esta fun√ß√£o para atualizar gr√°ficos
        function updateCharts(vendasHoje, produtos) {
            try {
                // Gr√°fico de pizza - Produtos mais vendidos hoje
                const vendasPorProduto = {};
                vendasHoje.forEach(venda => {
                    venda.itens.forEach(item => {
                        if (!vendasPorProduto[item.nome]) {
                            vendasPorProduto[item.nome] = 0;
                        }
                        vendasPorProduto[item.nome] += item.quantidade;
                    });
                });
                
                const ctx1 = document.getElementById('flavorsChart');
                if (ctx1) {
                    if (charts.flavors) charts.flavors.destroy();
                    
                    if (Object.keys(vendasPorProduto).length > 0) {
                        charts.flavors = new Chart(ctx1.getContext('2d'), {
                            type: 'pie',
                            data: {
                                labels: Object.keys(vendasPorProduto),
                                datasets: [{
                                    data: Object.values(vendasPorProduto),
                                    backgroundColor: Object.keys(vendasPorProduto).map(nome => {
                                        const produto = produtos.find(p => p.nome === nome);
                                        return produto ? produto.cor : '#CCCCCC';
                                    }),
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'bottom' }
                                }
                            }
                        });
                    }
                }
                
                // Gr√°fico de linha - Evolu√ß√£o semanal
                const ultimos7Dias = [];
                const vendasPorDia = [];
                
                for (let i = 6; i >= 0; i--) {
                    const data = new Date();
                    data.setDate(data.getDate() - i);
                    const dataStr = data.toISOString().split('T')[0];
                    ultimos7Dias.push(formatarData(dataStr));
                    
                    // Filtra vendas por dia
                    const vendasDia = vendasHoje.filter(v => v.data === dataStr);
                    const totalDia = vendasDia.reduce((sum, v) => sum + v.total, 0);
                    vendasPorDia.push(totalDia);
                }
                
                const ctx2 = document.getElementById('weeklyChart');
                if (ctx2) {
                    if (charts.weekly) charts.weekly.destroy();
                    
                    charts.weekly = new Chart(ctx2.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ultimos7Dias,
                            datasets: [{
                                label: 'Faturamento (R$)',
                                data: vendasPorDia,
                                borderColor: '#36B5B0',
                                backgroundColor: 'rgba(54, 181, 176, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao atualizar gr√°ficos:', error);
            }
        }
        
        function formatarData(dataStr) {
            try {
                const [year, month, day] = dataStr.split('-');
                return `${day}/${month}`;
            } catch (error) {
                return dataStr;
            }
        }

    </script>
</body>
</html>
